<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Basics of Android GCM</title>
  <meta name="description" content="How did I do
" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://shrikanthkr.github.io/android/2015/09/08/android-gcm.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" >

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
  <link rel="stylesheet" type="text/css"  href="/css/prism.css" />
  <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>

  <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
  <script type="text/javascript" src="/assets/js/index.js"></script>
  <script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
  <script type="text/javascript" src="/assets/js/prism.js"></script>
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://shrikanthkr.github.io" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/logo.jpg)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="article-image">
          <div class="post-image-image" style="background-image: url(/assets/article_images/borders-android/background.png)">
            Article Image
          </div>
          <div class="post-meta">
            <h1 class="post-title">Basics of Android GCM</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Shrikanth</h4>
              on
              <time datetime="2015-09-08 14:34">08 Sep 2015</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
            <div style="text-align:center">
              <a href="#topofpage" class="topofpage"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </div>
        <script>
          (function ($) {
              "use strict";
              $(document).ready(function(){
                  var $window = $(window),
                      $image = $('.post-image-image');
                  $window.on('scroll', function() {
                      var top = $window.scrollTop();

                      if (top < 0 || top > 1500) { return; }
                      $image
                          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
                          .css('opacity', 1-Math.max(top/700, 0));
                  });
                  $window.trigger('scroll');

                  var height = $('.article-image').height();
                      $('.post-content').css('padding-top', height + 'px');

                  $(function() {
                    $('a[href*=#]:not([href=#])').click(function() {
                      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
                        var target = $(this.hash);
                        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
                        if (target.length) {
                          $('html,body').animate({
                            scrollTop: target.offset().top
                          }, 500);
                          return false;
                        }
                      }
                    });
                  });

              });

          }(jQuery));
        </script>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>Google Cloud Messaging (GCM) is a service that enables developers to send data from servers to both <code>Android</code> applications or <code>Chrome</code> apps and extensions. <a href="https://en.wikipedia.org/wiki/Google_Cloud_Messaging">Wikipedia</a>.</p>

<hr>

<p>GCM basics involves four steps</p>

<ul>
<li>Registering the client (Android Device)</li>
<li>Provide the registration ID to server</li>
<li>Send notifications from Server to GCM with registration ID</li>
<li>Receive notifications on the client</li>
</ul>

<h4>Prerequisite</h4>

<ul>
<li>Project Number (<em>845696541232</em>)</li>
<li>Server API Key (<em>XIzaSyBDRJ00YJbTE011CbWWjlcKYUGI3eLccdI</em>)</li>
</ul>

<p>Refer to <a href="https://developers.google.com/console/help/new/#creatingdeletingprojects">Create Project</a> on creating a new project and <a href="https://developers.google.com/console/help/new/#api-keys">Generate API Key</a> for generating a Server key(API Key)</p>

<p>Once we have all the required data we can start with our client registration process.</p>

<h4>Creating a new Project</h4>

<p>Ensure that we have the necessary dependencies added.</p>

<blockquote>
<p>app/build.gradle</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-javascript'>dependencies {
    compile fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
    compile &#39;com.android.support:appcompat-v7:21.0.3&#39;
    compile &#39;com.google.android.gms:play-services:6.5.87&#39;
}</code></pre>
</div>

<hr>

<p>Adding Permissions</p>

<blockquote>
<p>app/src/main/Androidmanifest.xml</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-markup'>&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    ...
    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot; /&gt;
    &lt;uses-permission android:name=&quot;com.google.android.c2dm.permission.RECEIVE&quot; /&gt;
    &lt;permission android:name=&quot;com.example.gcm.permission.C2D_MESSAGE&quot; android:protectionLevel=&quot;signature&quot; /&gt;
    &lt;uses-permission android:name=&quot;com.example.gcm.permission.C2D_MESSAGE&quot; /&gt;
    ...      
&lt;/manifest&gt;</code></pre>
</div>

<hr>

<h4>Registering the client (Android Device)</h4>

<p>The client part has an interface with a registration button. On click of the button a call to GCM is made and <code>Registration ID</code> is obtained. While making the request it is necessary to note that we have the correct <em><strong>Project Number</strong></em> from the developers console.</p>

<blockquote>
<p>res/layout/activity_main.xml</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-markup'>&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
                xmlns:tools=&quot;http://schemas.android.com/tools&quot;
                android:layout_width=&quot;match_parent&quot;
                android:layout_height=&quot;match_parent&quot;
                android:paddingLeft=&quot;@dimen/activity_horizontal_margin&quot;
                android:paddingRight=&quot;@dimen/activity_horizontal_margin&quot;
                android:paddingTop=&quot;@dimen/activity_vertical_margin&quot;
                android:paddingBottom=&quot;@dimen/activity_vertical_margin&quot;
                tools:context=&quot;.MainActivity&quot;&gt;
    &lt;Button
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:text=&quot;Register&quot;
        android:id=&quot;@+id/register&quot;
        android:layout_below=&quot;@+id/textView&quot;
        android:layout_centerHorizontal=&quot;true&quot;
        android:layout_marginTop=&quot;117dp&quot;/&gt;

&lt;/RelativeLayout&gt;</code></pre>
</div>

<hr>

<blockquote>
<p>src/main/java/.../MainActivity.java</p>
</blockquote>

<p>Declaring necessary variables and functions</p>

<div>
  <pre data-line=''><code class='language-javascript'>Button register_button;
String PROJECT_NUMBER = &quot;845696541232&quot;;
GoogleCloudMessaging gcmObj;
String regId;

 protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    register_button = (Button) findViewById(R.id.register);
    register_button.setOnClickListener(new View.OnClickListener() {
      @Override
      public void onClick(View v) {
        registerInBackground();
      }
    });</code></pre>
</div>

<hr>

<p>Writing the registration function</p>

<div>
  <pre data-line=''><code class='language-javascript'>private void registerInBackground() {
    new AsyncTask&lt;Void, Void, String&gt;() {
        @Override
        protected String doInBackground(Void... params) {
            String msg = &quot;&quot;;
            try {
                gcmObj = GoogleCloudMessaging.getInstance(getApplicationContext());
                regId = gcmObj.register(PROJECT_NUMBER);
                msg = &quot;Registration ID :&quot; + regId;
            } catch (IOException ex) { msg = ex.getMessage();}
            return msg;
        }
        @Override
        protected void onPostExecute(String msg) {
            Toast.makeText(getApplicationContext(),&quot;Registered with GCM Server successfully.\n\n&quot;+ msg, Toast.LENGTH_SHORT).show();
            Log.d(&quot;MainActivity&quot;, regId);
        }
    }.execute(null, null, null);
}</code></pre>
</div>

<hr>

<h4>Provide the registration ID to server</h4>

<p>Once the registration is successful,  <code>Registration ID</code> is obtained. This <code>Registration ID</code> is used by the server to send notifications to device. In our sample the <code>Registration ID</code> printed in logs is copied and used in the server part.</p>

<h4>Send notifications from Server to GCM with <em>Registration ID</em> (Server Part)</h4>

<p>The sample server code here is written in Nodejs. Using <code>node-gcm</code> library we can easily send messages to <strong>GCM</strong>. The server part includes two files. </p>

<ul>
<li>package.json</li>
<li>node-gcm-sample.js</li>
</ul>

<blockquote>
<p>package.json</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-javascript'>{
  &quot;dependencies&quot;: {
    &quot;node-gcm&quot;: &quot;git+https://github.com/ToothlessGear/node-gcm.git&quot;
  }
}</code></pre>
</div>

<hr>

<blockquote>
<p>node-gcm-sample.js</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-javascript'>var gcm = require(&#39;node-gcm&#39;);
var message = new gcm.Message();
message.addData(&#39;key1&#39;, &#39;Awesome World!!&#39;); /*Message to the client*/

var regIds = [&#39;COPIED_ID_FROM_ANDROID_LOGS&#39;];
var sender = new gcm.Sender(&#39;SERVER_API_KEY&#39;);

sender.send(message, { registrationIds: regIds } , function (err, result) {
  if(err) console.error(err);
  else    console.log(result);
});</code></pre>
</div>

<hr>

<p>Create both the files in a project folder, and execute <code>npm install</code></p>

<h4>Receive notifications on the client</h4>

<p>Now we enter into the last part of preparing our client to receive notifications. We have to intimate the client to listen for notifications using a <code>Receiver</code> and a <code>Service</code> to handle the data from server.</p>

<blockquote>
<p>src/main/java/.../GCMReceiver.java</p>
</blockquote>

<p>Receiver code stating the necessary service <code>(GCMIntentService)</code> to be triggered.</p>

<div>
  <pre data-line=''><code class='language-javascript'>public class GCMReceiver extends WakefulBroadcastReceiver{
    @Override
    public void onReceive(Context context, Intent intent) {
        ComponentName comp = new ComponentName(context.getPackageName(),GCMIntentService.class.getName());
        startWakefulService(context, (intent.setComponent(comp)));
        setResultCode(Activity.RESULT_OK);
    }
}</code></pre>
</div>

<hr>

<p>Update Androidmanifest</p>

<blockquote>
<p>app/src/main/Androidmanifest.xml</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-markup'>&lt;receiver
    android:name=&quot;.GCMReceiver&quot;
    android:exported=&quot;true&quot;
    android:permission=&quot;com.google.android.c2dm.permission.SEND&quot; &gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;com.google.android.c2dm.intent.RECEIVE&quot; /&gt;
        &lt;category android:name=&quot;com.example.gcm&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;</code></pre>
</div>

<hr>

<blockquote>
<p>src/main/java/.../GCMReceiver.java</p>
</blockquote>

<p>Service code for handling the notifications part. Here <code>MESSAGE_KEY</code> is the expected key that is set from the server. </p>

<div>
  <pre data-line=''><code class='language-javascript'>public class GCMIntentService extends IntentService {
    String MESSAGE_KEY = &quot;key1&quot;;
    public GCMIntentService() {
        super(&quot;Message&quot;);
    }
    @Override
    protected void onHandleIntent(Intent intent) {
        Bundle extras = intent.getExtras();
        String message = intent.getStringExtra(MESSAGE_KEY);
        GoogleCloudMessaging gcm = GoogleCloudMessaging.getInstance(this);
        String messageType = gcm.getMessageType(intent);
        final int notificationID = (int) (Math.random() * 100000000);

        if (GoogleCloudMessaging.MESSAGE_TYPE_SEND_ERROR.equals(messageType)) {
            sendNotification(&quot;GCM notification: Send error&quot; + extras.toString(), notificationID);
        }else if (GoogleCloudMessaging.MESSAGE_TYPE_DELETED.equals(messageType)) {
            sendNotification(&quot;Deleted messages on server&quot; + extras.toString(), notificationID);
        }else if (GoogleCloudMessaging.MESSAGE_TYPE_MESSAGE.equals(messageType)) {
            sendNotification(message, notificationID);
        }
        GCMReceiver.completeWakefulIntent(intent);
    }

    private void sendNotification(String msg, int notificationID) {
        NotificationCompat.Builder builder = new NotificationCompat.Builder(this)
        .setSmallIcon(R.drawable.common_ic_googleplayservices);
        .setContentTitle(&quot;Notification&quot;);
        .setContentText(msg);
        Intent resultIntent = new Intent(this, MainActivity.class);
        PendingIntent resultPendingIntent = PendingIntent.getActivity(this,0,resultIntent, PendingIntent.FLAG_UPDATE_CURRENT);
        NotificationManager mNotifyMgr = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
        mNotifyMgr.notify(notificationID, builder.build());
    }
}</code></pre>
</div>

<hr>

<p>Update Androidmanifest</p>

<blockquote>
<p>app/src/main/Androidmanifest.xml</p>
</blockquote>

<div>
  <pre data-line=''><code class='language-markup'>&lt;service
    android:name=&quot;.GCMIntentService&quot;
    android:exported=&quot;false&quot; &gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;com.google.android.c2dm.intent.RECEIVE&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;</code></pre>
</div>

<hr>

<p>Now we are ready to check if our GCM component is working. Run the app in a device connected to internet, and open your server project folder from termial. Run <code>node node-gcm-sample.js</code>.Source code for <a href="https://github.com/shrikanthkr/android-gcm-client">Android Client</a> and <a href="https://github.com/shrikanthkr/node-gcm-sample">Node Server</a></p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Basics+of+Android+GCM&amp;url=http://shrikanthkr.github.io/android/2015/09/08/android-gcm"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Shrikanth</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2015-09-08 14:34">08 Sep 2015</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Shrikanth</a> &copy; 2014<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/background.jpg)">
      Image
    </div>
    <div class="inner">
      <h1 class="blog-title">Blog</h1>
      <h2 class="blog-description">How did I do
</h2>
      <a href="/" class="btn">Back to Overview</a>
    </div>
    </div>
  </body>
</html>
